<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multi-Section Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
      }

      .header h1 {
        font-size: 2.5em;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .header-controls {
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .section-filter {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 10px 15px;
        border-radius: 25px;
        font-size: 0.9em;
        font-weight: 500;
      }

      .section-filter option {
        background: #4f46e5;
        color: white;
      }

      .refresh-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .refresh-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      .config-notice {
        background: #fef3c7;
        color: #92400e;
        padding: 15px;
        margin: 20px;
        border-radius: 10px;
        border-left: 4px solid #f59e0b;
        font-size: 0.9em;
      }

      .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        padding: 30px;
        background: #f8fafc;
      }

      .summary-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      }

      .summary-card h3 {
        color: #64748b;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
      }

      .summary-card .value {
        font-size: 2.2em;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 5px;
      }

      .summary-card .change {
        font-size: 0.9em;
        font-weight: 500;
      }

      .positive {
        color: #059669;
      }
      .negative {
        color: #dc2626;
      }

      .section-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        padding: 30px;
        background: #f1f5f9;
      }

      .section-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-left: 5px solid;
        transition: transform 0.3s ease;
      }

      .section-card:hover {
        transform: translateY(-3px);
      }

      .section-card.education {
        border-left-color: #4f46e5;
      }

      .section-card.women-empowerment {
        border-left-color: #ec4899;
      }

      .section-card.welfare {
        border-left-color: #10b981;
      }

      .section-card h3 {
        color: #1e293b;
        font-size: 1.3em;
        margin-bottom: 15px;
      }

      .section-stats {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .section-stat {
        text-align: center;
      }

      .section-stat .label {
        font-size: 0.8em;
        color: #64748b;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .section-stat .value {
        font-size: 1.4em;
        font-weight: 700;
        color: #1e293b;
        margin-top: 5px;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
        padding: 30px;
      }

      .chart-container {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .chart-container:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f5f9;
      }

      .chart-title {
        font-size: 1.4em;
        font-weight: 700;
        color: #1e293b;
      }

      .chart-subtitle {
        font-size: 0.9em;
        color: #64748b;
        margin-top: 5px;
      }

      .chart-canvas {
        position: relative;
        height: 350px;
        margin: 20px 0;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        font-size: 1.2em;
        color: #64748b;
      }

      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4f46e5;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin-right: 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error {
        background: #fee2e2;
        color: #dc2626;
        padding: 20px;
        border-radius: 10px;
        margin: 20px;
        text-align: center;
      }

      .last-updated {
        text-align: center;
        color: #64748b;
        font-size: 0.9em;
        padding: 20px;
        background: #f8fafc;
      }

      .filter-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .filter-select {
        padding: 8px 15px;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: white;
        font-size: 0.9em;
        transition: border-color 0.3s ease;
      }

      .filter-select:focus {
        outline: none;
        border-color: #4f46e5;
      }

      @media (max-width: 768px) {
        .charts-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2em;
        }

        .header-controls {
          position: static;
          transform: none;
          margin-top: 15px;
          justify-content: center;
        }

        .section-overview {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="header">
        <h1>Multi-Section Analytics</h1>
        <p>Education, Women Empowerment & Welfare Insights</p>
        <div class="header-controls">
          <select class="section-filter" id="sectionFilter" onchange="updateDashboard()">
            <option value="">All Sections</option>
            <option value="Education">Education</option>
            <option value="Women Empowerment">Women Empowerment</option>
            <option value="Welfare">Welfare</option>
          </select>
          <button class="refresh-btn" onclick="loadData()">
            <span id="refresh-icon">ðŸ”„</span> Refresh
          </button>
        </div>
      </div>

      <div class="config-notice" id="config-notice">
        <strong>Setup Required:</strong> Replace
        YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE with your actual Apps Script
        Web App URL and set USE_LIVE_DATA to true.
      </div>

      <div class="summary-cards">
        <div class="summary-card">
          <h3>Total Expenses</h3>
          <div class="value" id="total-amount">â‚¹0</div>
          <div class="change" id="total-change">Loading...</div>
        </div>
        <div class="summary-card">
          <h3>Total Transactions</h3>
          <div class="value" id="total-transactions">0</div>
          <div class="change" id="transaction-change">Loading...</div>
        </div>
        <div class="summary-card">
          <h3>Average Amount</h3>
          <div class="value" id="avg-amount">â‚¹0</div>
          <div class="change" id="avg-change">Loading...</div>
        </div>
        <div class="summary-card">
          <h3>Active Sections</h3>
          <div class="value" id="active-sections">0</div>
          <div class="change">Sections with data</div>
        </div>
      </div>

      <div class="section-overview" id="section-overview">
        <!-- Section cards will be populated dynamically -->
      </div>

      <div class="charts-grid">
        <div class="chart-container" id="all-section">
          <div class="chart-header">
            <div>
              <div class="chart-title">Expenses by Section</div>
              <div class="chart-subtitle">
                Distribution across different sections
              </div>
            </div>
          </div>
          <div class="chart-canvas">
            <canvas id="sectionChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div>
              <div class="chart-title">Expenses by Category</div>
              <div class="chart-subtitle">
                Category-wise expense distribution
              </div>
            </div>
          </div>
          <div class="chart-canvas">
            <canvas id="categoryChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div>
              <div class="chart-title">Payment Methods</div>
              <div class="chart-subtitle">Transaction mode analysis</div>
            </div>
          </div>
          <div class="chart-canvas">
            <canvas id="paymentChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div>
              <div class="chart-title">Monthly Trends</div>
              <div class="chart-subtitle">Spending patterns over time</div>
            </div>
            <div class="filter-controls">
              <select
                class="filter-select"
                id="yearFilter"
                onchange="updateMonthlyChart()"
              >
                <option value="">All Years</option>
              </select>
            </div>
          </div>
          <div class="chart-canvas">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <div>
              <div class="chart-title">Top Expenses</div>
              <div class="chart-subtitle">Highest individual transactions</div>
            </div>
          </div>
          <div class="chart-canvas">
            <canvas id="topExpensesChart"></canvas>
          </div>
        </div>
      </div>

      <div class="last-updated" id="last-updated">Last updated: Loading...</div>
    </div>

    <script>
      // Configuration - Replace with your Google Apps Script Web App URL
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbygZujuh16ayy0JzbgK92de2JJh7liPeoN07UtHvOSMwccgFPbQTlShFuUsT_-4Nshl/exec";

      // Set to true to use live Google Sheets data, false to use sample data
      const USE_LIVE_DATA = true;

      let globalData = {};
      let globalSummary = {};
      let filteredData = [];
      let charts = {};

      // Color palettes for charts
      const colorPalettes = {
        sections: {
          'Education': '#4f46e5',
          'Women Empowerment': '#ec4899',
          'Welfare': '#10b981'
        },
        category: [
          "#4f46e5", "#7c3aed", "#ec4899", "#ef4444", "#f59e0b", "#10b981",
          "#06b6d4", "#8b5cf6", "#f97316", "#84cc16", "#06b6d4", "#f59e0b"
        ],
        payment: ["#3b82f6", "#1d4ed8", "#1e40af", "#1e3a8a", "#312e81"],
        monthly: "#6366f1",
        expenses: ["#ef4444", "#dc2626", "#b91c1c", "#991b1b", "#7f1d1d"],
      };

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", function () {
        updateConfigNotice();
        loadData();

        // Set up auto-refresh every 5 minutes
        setInterval(loadData, 5 * 60 * 1000);
      });

      function updateConfigNotice() {
        const notice = document.getElementById("config-notice");
        if (
          USE_LIVE_DATA &&
          SCRIPT_URL !== "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE"
        ) {
          notice.style.display = "none";
        } else {
          notice.style.display = "block";
        }
      }

      // Load data from Google Apps Script
      async function loadData() {
        try {
          showLoading();

          let result;

          if (
            USE_LIVE_DATA &&
            SCRIPT_URL !== "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE"
          ) {
            // Fetch from Google Sheets via Apps Script
            const response = await fetch(`${SCRIPT_URL}?action=getData`);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            result = await response.json();
            if (result.status === "error") {
              throw new Error(result.error);
            }
          } else {
            // Use sample data matching your Apps Script structure
            result = generateSampleData();
          }

          globalData = result.data || {};
          globalSummary = result.summary || {};

          // Process and fix dates
          Object.keys(globalData).forEach(section => {
            globalData[section].forEach(item => {
              if (item.parsedDate) {
                item.parsedDate = new Date(item.parsedDate);
              }
            });
          });

          updateDashboard();
          updateLastUpdated(result.lastUpdated);
        } catch (error) {
          showError("Failed to load data: " + error.message);
          console.error("Error loading data:", error);
        }
      }

      // Generate sample data matching your Apps Script structure
      function generateSampleData() {
        const educationData = [
          {
            id: "education_1",
            section: "Education",
            date: "Feb 2025",
            description: "SEED Contribution 11 students",
            amount: 141500,
            finalAmount: 141500,
            type: "NEFT Transaction",
            category: "Educational Support",
            parsedDate: new Date("2025-02-15"),
          },
          {
            id: "education_2",
            section: "Education",
            date: "Feb 2025",
            description: "Scholarships for 52 students",
            amount: 528000,
            finalAmount: 528000,
            type: "NEFT Transaction",
            category: "Scholarships",
            parsedDate: new Date("2025-02-20"),
          },
          {
            id: "education_3",
            section: "Education",
            date: "Dec 2024",
            description: "Semester Fees for two students",
            amount: 27000,
            finalAmount: 27000,
            type: "NEFT Transaction",
            category: "Institution Fees",
            parsedDate: new Date("2024-12-15"),
          }
        ];

        const womenEmpowermentData = [
          {
            id: "women_empowerment_1",
            section: "Women Empowerment",
            date: "Jan 2025",
            description: "Skill Development Workshop",
            amount: 25000,
            finalAmount: 25000,
            type: "NEFT Transaction",
            category: "Skill Development",
            parsedDate: new Date("2025-01-15"),
          },
          {
            id: "women_empowerment_2",
            section: "Women Empowerment",
            date: "Dec 2024",
            description: "Microfinance Support",
            amount: 50000,
            finalAmount: 50000,
            type: "NEFT Transaction",
            category: "Financial Assistance",
            parsedDate: new Date("2024-12-10"),
          }
        ];

        const welfareData = [
          {
            id: "welfare_1",
            section: "Welfare",
            date: "Feb 2025",
            description: "Food Distribution Program",
            amount: 35000,
            finalAmount: 35000,
            type: "Cash",
            category: "Food & Nutrition",
            parsedDate: new Date("2025-02-05"),
          },
          {
            id: "welfare_2",
            section: "Welfare",
            date: "Jan 2025",
            description: "Medical Camp",
            amount: 40000,
            finalAmount: 40000,
            type: "NEFT Transaction",
            category: "Medical Care",
            parsedDate: new Date("2025-01-20"),
          }
        ];

        const data = {
          "Education": educationData,
          "Women Empowerment": womenEmpowermentData,
          "Welfare": welfareData
        };

        const summary = {};
        Object.keys(data).forEach(section => {
          summary[section] = {
            totalRecords: data[section].length,
            totalAmount: data[section].reduce((sum, item) => sum + item.finalAmount, 0),
            categories: [...new Set(data[section].map(item => item.category))]
          };
        });

        return {
          data: data,
          summary: summary,
          totalRecords: Object.values(data).reduce((sum, arr) => sum + arr.length, 0),
          lastUpdated: new Date().toISOString(),
          status: "success",
        };
      }

      function updateDashboard() {
        updateFilteredData();
        updateSummaryCards();
        updateSectionOverview();
        createAllCharts();
      }

      function updateFilteredData() {
        const selectedSection = document.getElementById("sectionFilter").value;
        
        if (selectedSection) {
          filteredData = globalData[selectedSection] || [];
        } else {
          filteredData = [];
          Object.values(globalData).forEach(sectionData => {
            filteredData.push(...sectionData);
          });
        }
      }

      function showLoading() {
        const summaryCards = document.querySelectorAll(".summary-card .value");
        summaryCards.forEach((card) => {
          card.innerHTML = '<div class="spinner"></div>';
        });
      }

      function showError(message) {
        const container = document.querySelector(".charts-grid");
        container.innerHTML = `<div class="error">${message}</div>`;
      }

      function updateSummaryCards() {
        const totalAmount = filteredData.reduce((sum, item) => sum + (item.finalAmount || 0), 0);
        const avgAmount = filteredData.length > 0 ? totalAmount / filteredData.length : 0;
        const activeSections = Object.keys(globalData).filter(section => 
          globalData[section] && globalData[section].length > 0
        ).length;

        document.getElementById("total-amount").textContent = `â‚¹${totalAmount.toLocaleString("en-IN")}`;
        document.getElementById("total-transactions").textContent = filteredData.length;
        document.getElementById("avg-amount").textContent = `â‚¹${Math.round(avgAmount).toLocaleString("en-IN")}`;
        document.getElementById("active-sections").textContent = activeSections;

        // Update change indicators
        const selectedSection = document.getElementById("sectionFilter").value;
        const sectionText = selectedSection ? `${selectedSection} section` : "all sections";
        
        document.getElementById("total-change").innerHTML = `<span class="positive">From ${sectionText}</span>`;
        document.getElementById("transaction-change").innerHTML = `<span class="positive">Active records</span>`;
        document.getElementById("avg-change").innerHTML = `<span class="positive">Per transaction</span>`;
      }

      function updateSectionOverview() {
        const container = document.getElementById("section-overview");
        const selectedSection = document.getElementById("sectionFilter").value;
        
        if (selectedSection) {
          container.style.display = 'none';
          return;
        }
        
        container.style.display = 'grid';
        container.innerHTML = '';

        Object.keys(globalSummary).forEach(section => {
          const summary = globalSummary[section];
          const sectionClass = section.toLowerCase().replace(/\s+/g, '-');
          
          const card = document.createElement('div');
          card.className = `section-card ${sectionClass}`;
          card.innerHTML = `
            <h3>${section}</h3>
            <div class="section-stats">
              <div class="section-stat">
                <div class="label">Records</div>
                <div class="value">${summary.totalRecords}</div>
              </div>
              <div class="section-stat">
                <div class="label">Amount</div>
                <div class="value">â‚¹${(summary.totalAmount / 1000).toFixed(0)}k</div>
              </div>
              <div class="section-stat">
                <div class="label">Categories</div>
                <div class="value">${summary.categories.length}</div>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      }

      function createAllCharts() {
        createSectionChart();
        createCategoryChart();
        createPaymentChart();
        createMonthlyChart();
        createTopExpensesChart();
        populateYearFilter();
      }

      function createSectionChart() {
        const ctx = document.getElementById("sectionChart").getContext("2d");

        if (charts.section) {
          charts.section.destroy();
        }

        // If a specific section is selected, skip this chart
        const selectedSection = document.getElementById("sectionFilter").value;
        if (selectedSection) {
          ctx.canvas.style.display = 'none';
          return;
        }
        
        ctx.canvas.style.display = 'block';

        const sectionData = {};
        Object.keys(globalData).forEach(section => {
          sectionData[section] = globalData[section].reduce((sum, item) => sum + (item.finalAmount || 0), 0);
        });

        const labels = Object.keys(sectionData);
        const data = Object.values(sectionData);
        const colors = labels.map(label => colorPalettes.sections[label] || '#64748b');

        charts.section = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderWidth: 3,
                borderColor: "#fff",
                hoverBorderWidth: 5,
                hoverBorderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  font: { size: 12 },
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.9)",
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: â‚¹${context.parsed.toLocaleString("en-IN")} (${percentage}%)`;
                  },
                },
              },
            },
            animation: { animateRotate: true, duration: 2000 },
          },
        });
      }

      function createCategoryChart() {
        const ctx = document.getElementById("categoryChart").getContext("2d");

        if (charts.category) {
          charts.category.destroy();
        }

        // Group data by category using finalAmount
        const categoryData = {};
        filteredData.forEach((item) => {
          const category = item.category || "Other";
          if (!categoryData[category]) {
            categoryData[category] = 0;
          }
          categoryData[category] += item.finalAmount || 0;
        });

        const labels = Object.keys(categoryData);
        const data = Object.values(categoryData);

        charts.category = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colorPalettes.category.slice(0, labels.length),
                borderWidth: 3,
                borderColor: "#fff",
                hoverBorderWidth: 5,
                hoverBorderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  font: { size: 12 },
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.9)",
                titleColor: "#fff",
                bodyColor: "#fff",
                borderColor: "#4f46e5",
                borderWidth: 2,
                cornerRadius: 8,
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: â‚¹${context.parsed.toLocaleString("en-IN")} (${percentage}%)`;
                  },
                },
              },
            },
            animation: { animateRotate: true, duration: 2000 },
          },
        });
      }

      function createPaymentChart() {
        const ctx = document.getElementById("paymentChart").getContext("2d");

        if (charts.payment) {
          charts.payment.destroy();
        }

        // Group data by payment type using finalAmount
        const paymentData = {};
        filteredData.forEach((item) => {
          const type = item.type || "Other";
          if (!paymentData[type]) {
            paymentData[type] = 0;
          }
          paymentData[type] += item.finalAmount || 0;
        });

        const labels = Object.keys(paymentData);
        const data = Object.values(paymentData);

        charts.payment = new Chart(ctx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: data,
                backgroundColor: colorPalettes.payment.slice(0, labels.length),
                borderWidth: 3,
                borderColor: "#fff",
                hoverBorderWidth: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  padding: 20,
                  usePointStyle: true,
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.9)",
                callbacks: {
                  label: function (context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                    return `${context.label}: â‚¹${context.parsed.toLocaleString("en-IN")} (${percentage}%)`;
                  },
                },
              },
            },
            animation: { duration: 2000 },
          },
        });
      }

      function createMonthlyChart() {
        const ctx = document.getElementById("monthlyChart").getContext("2d");

        if (charts.monthly) {
          charts.monthly.destroy();
        }

        // Group data by month using parsedDate and finalAmount
        const monthlyData = {};
        filteredData.forEach((item) => {
          if (item.parsedDate) {
            const monthYear = item.parsedDate.toLocaleDateString("en-IN", {
              year: "numeric",
              month: "short",
            });
            if (!monthlyData[monthYear]) {
              monthlyData[monthYear] = 0;
            }
            monthlyData[monthYear] += item.finalAmount || 0;
          }
        });

        // Sort by date
        const sortedEntries = Object.entries(monthlyData).sort(
          (a, b) => new Date(a[0]) - new Date(b[0])
        );
        const labels = sortedEntries.map((entry) => entry[0]);
        const data = sortedEntries.map((entry) => entry[1]);

        charts.monthly = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Monthly Expenses",
                data: data,
                borderColor: colorPalettes.monthly,
                backgroundColor: colorPalettes.monthly + "20",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: colorPalettes.monthly,
                pointBorderColor: "#fff",
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.9)",
                callbacks: {
                  label: function (context) {
                    return `Expenses: â‚¹${context.parsed.y.toLocaleString("en-IN")}`;
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "â‚¹" + value.toLocaleString("en-IN");
                  },
                },
              },
            },
            animation: { duration: 2000, easing: "easeInOutQuart" },
          },
        });
      }

      function createTopExpensesChart() {
        const ctx = document.getElementById("topExpensesChart").getContext("2d");

        if (charts.topExpenses) {
          charts.topExpenses.destroy();
        }

        // Get top 5 expenses by finalAmount
        const topExpenses = [...filteredData]
          .sort((a, b) => (b.finalAmount || 0) - (a.finalAmount || 0))
          .slice(0, 5);

        const labels = topExpenses.map((item) => {
          const desc = item.description || "No description";
          return desc.length > 25 ? desc.substring(0, 25) + "..." : desc;
        });
        const data = topExpenses.map((item) => item.finalAmount || 0);

        charts.topExpenses = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Amount",
                data: data,
                backgroundColor: colorPalettes.expenses.slice(0, data.length),
                borderRadius: 8,
                borderSkipped: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.9)",
                callbacks: {
                  title: function (context) {
                    const index = context[0].dataIndex;
                    return topExpenses[index].description || "No description";
                  },
                  label: function (context) {
                    const index = context.dataIndex;
                    const item = topExpenses[index];
                    return [
                      `Amount: â‚¹${context.parsed.x.toLocaleString("en-IN")}`,
                      `Section: ${item.section || 'N/A'}`,
                      `Category: ${item.category || 'N/A'}`
                    ];
                  },
                },
              },
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  callback: function (value) {
                    return "â‚¹" + value.toLocaleString("en-IN");
                  },
                },
              },
            },
            animation: { duration: 2000, easing: "easeInOutQuart" },
          },
        });
      }

      function populateYearFilter() {
        const yearFilter = document.getElementById("yearFilter");
        const years = [
          ...new Set(
            filteredData
              .filter((item) => item.parsedDate)
              .map((item) => item.parsedDate.getFullYear())
          ),
        ]
          .sort()
          .reverse();

        yearFilter.innerHTML = '<option value="">All Years</option>';
        years.forEach((year) => {
          yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
        });
      }

      function updateMonthlyChart() {
        const selectedYear = document.getElementById("yearFilter").value;
        let yearFilteredData = filteredData;

        if (selectedYear) {
          yearFilteredData = filteredData.filter(
            (item) =>
              item.parsedDate && item.parsedDate.getFullYear() == selectedYear
          );
        }

        // Recreate monthly chart with filtered data
        const monthlyData = {};
        yearFilteredData.forEach((item) => {
          if (item.parsedDate) {
            const monthYear = item.parsedDate.toLocaleDateString("en-IN", {
              year: "numeric",
              month: "short",
            });
            if (!monthlyData[monthYear]) {
              monthlyData[monthYear] = 0;
            }
            monthlyData[monthYear] += item.finalAmount || 0;
          }
        });

        const sortedEntries = Object.entries(monthlyData).sort(
          (a, b) => new Date(a[0]) - new Date(b[0])
        );
        const labels = sortedEntries.map((entry) => entry[0]);
        const data = sortedEntries.map((entry) => entry[1]);

        charts.monthly.data.labels = labels;
        charts.monthly.data.datasets[0].data = data;
        charts.monthly.update();
      }

      function updateLastUpdated(lastUpdated) {
        const updateTime = lastUpdated ? new Date(lastUpdated) : new Date();
        document.getElementById(
          "last-updated"
        ).textContent = `Last updated: ${updateTime.toLocaleDateString(
          "en-IN"
        )} at ${updateTime.toLocaleTimeString("en-IN")}`;
      }

      // Auto-refresh animation
      function animateRefresh() {
        const icon = document.getElementById("refresh-icon");
        icon.style.transform = "rotate(360deg)";
        icon.style.transition = "transform 0.5s ease";
        setTimeout(() => {
          icon.style.transform = "rotate(0deg)";
        }, 500);
      }

      // Add refresh animation to load data
      const originalLoadData = loadData;
      loadData = function () {
        animateRefresh();
        return originalLoadData();
      };
    </script>
  </body>
</html>
